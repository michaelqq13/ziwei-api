# 凶星功能說明

## 功能概述

新增了"凶星"按鈕功能，允許將原本使用時辰地支排列的吉凶星（文昌、文曲、地空、地劫、火星、鈴星）改為使用排盤時間的分鐘地支來排列。

## 功能特點

### 1. 凶星按鈕
- **按鈕名稱**: 凶星
- **位置**: 流運按鈕組中，四化按鈕前面
- **功能**: 切換吉凶星的排列依據
- **狀態指示**: 
  - 未激活：灰色背景，顯示"凶星"
  - 激活中：紅色背景，顯示"時辰地支"
  - 載入中：顯示"載入中..."，按鈕禁用

### 2. 影響的星曜
- **文昌星**: 原本依據出生時辰地支排列 → 改為依據排盤時間分鐘地支排列
- **文曲星**: 原本依據出生時辰地支排列 → 改為依據排盤時間分鐘地支排列
- **地空星**: 原本依據出生時辰地支排列 → 改為依據排盤時間分鐘地支排列
- **地劫星**: 原本依據出生時辰地支排列 → 改為依據排盤時間分鐘地支排列
- **火星**: 原本依據出生年支+時辰地支排列 → 改為依據出生年支+分鐘地支排列
- **鈴星**: 原本依據出生年支+時辰地支排列 → 改為依據出生年支+分鐘地支排列

### 3. 分鐘地支計算
- 每2分鐘為一個天干地支組合
- 一個時辰（120分鐘）完成一次六十甲子循環
- 排盤時間的分鐘地支用於重新計算星曜位置

## 使用方法

1. **啟動凶星模式**: 點擊"凶星"按鈕
2. **查看變化**: 命盤中的文昌、文曲、地空、地劫、火星、鈴星位置會根據分鐘地支重新排列
3. **恢復原狀態**: 點擊"時辰地支"按鈕回到原始排列
4. **狀態指示**: 界面右上角會顯示"凶星模式：分鐘地支排列"

## 技術實現

### 後端實現

#### 1. StarCalculator類新增方法
```python
def recalculate_evil_stars_with_minute_branch(self, birth_info: Dict, palaces: Dict, minute_branch: str):
    """
    使用分鐘地支重新計算凶星位置（文昌、文曲、地空、地劫、火星、鈴星）
    """
```

#### 2. 新增API端點
- **端點**: `/chart/evil-stars-minute-branch`
- **方法**: POST
- **參數**: 
  - `birth_data`: 出生資料
  - `minute_branch`: 排盤時間的分鐘地支
- **返回**: 更新後的命盤數據

### 前端實現

#### 1. 狀態管理
```typescript
const [isEvilStarsMinuteBranch, setIsEvilStarsMinuteBranch] = useState(false);
const [isEvilStarsLoading, setIsEvilStarsLoading] = useState(false);
```

#### 2. API服務
```typescript
export const getChartWithEvilStarsMinuteBranch = async (
  birthInfo: BirthInfo,
  minuteBranch: string
): Promise<ChartData>
```

#### 3. 回調處理
- 父組件App.tsx中實現`handleEvilStarsChange`
- 更新chartData狀態以反映星曜位置變化

## 視覺效果

### 1. 按鈕外觀
- **未激活**: `bg-gray-500/50 text-gray-300`
- **激活中**: `bg-red-500/80 text-white`
- **載入中**: 添加`opacity-50 cursor-not-allowed`

### 2. 狀態指示
- 右上角顯示紅色文字："凶星模式：分鐘地支排列"
- 說明文字更新為凶星模式說明

### 3. 說明文字
激活時顯示："凶星模式：文昌、文曲、地空、地劫、火星、鈴星使用排盤時間分鐘地支排列，點擊「時辰地支」回復原狀態"

## 注意事項

1. **切換邏輯**: 切換回時辰地支模式時會重新調用原始命盤API，避免頁面重載
2. **重置功能**: 「重置」按鈕可以正確重置凶星模式，將凶星狀態包含在功能檢測中
3. **數據一致性**: 凶星模式與其他功能（流運、太極點等）相互獨立
4. **性能考慮**: 每次切換都會重新計算星曜位置並更新整個命盤
5. **錯誤處理**: 包含完整的try-catch錯誤處理機制，API失敗時才使用頁面重載

## 未來改進

1. ✅ **更優雅的重置**: 已實現調用原始命盤API而非重新載入頁面
2. **組合功能**: 考慮與流運、太極點等功能的組合使用
3. **動畫效果**: 添加星曜位置變化的過渡動畫
4. **歷史記錄**: 記錄凶星模式的使用歷史 