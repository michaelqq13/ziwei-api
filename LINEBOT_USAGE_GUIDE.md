# LINE Bot 紫微斗數占卜系統使用指南

## 🎯 系統概述

本系統是一個基於LINE Bot的紫微斗數占卜和個人運勢查詢系統，提供以下主要功能：

### 🔮 占卜功能
- 基於當下時間和性別進行紫微斗數占卜
- 使用分鐘地支變換命宮太極點
- 提供四化解釋和本週運勢分析
- 免費會員每週可占卜一次

### 📊 個人運勢查詢
- 流年運勢分析
- 流月運勢分析  
- 流日運勢分析
- 需要付費會員權限

### 👤 會員制度
- **免費會員**：基本占卜功能
- **付費會員**：無限制使用所有功能
- **管理員**：全功能無限制

## 🚀 快速開始

### 1. 環境設置

首先運行設置腳本：

```bash
python linebot_setup.py
```

### 2. 配置環境變數

創建 `.env` 文件並添加以下配置：

```env
# LINE Bot 配置
LINE_CHANNEL_SECRET=your_channel_secret_here
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token_here

# 管理員配置
ADMIN_SECRET_PHRASE=紫微斗數管理
ADMIN_PASSWORD=admin123

# 數據庫配置
DATABASE_URL=sqlite:///./app.db
```

### 3. 啟動服務

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 4. 設置Webhook

在LINE Developers Console中設置Webhook URL：
- 生產環境：`https://your-domain.com/webhook`
- 本地測試：`https://your-ngrok-url.ngrok.io/webhook`

## 📱 用戶使用指南

### 基本操作

1. **加入好友**：掃描LINE Bot QR Code
2. **開始使用**：發送任意訊息開始
3. **主選單**：發送「主選單」或「menu」返回主選單

### 🔮 占卜功能使用

1. 點擊「🔮 占卜」按鈕
2. 首次使用需選擇性別（會記住偏好）
3. 系統自動基於當下時間進行占卜
4. 獲得詳細的運勢分析結果

**占卜結果包含：**
- 整體運勢摘要
- 事業、財運、感情、健康各面向分析
- 本週重點和建議
- 四化解釋（前3個）

### 📊 個人運勢查詢

#### 首次綁定命盤

1. 點擊「📊 個人運勢」→「📅 綁定命盤」
2. 依序輸入：
   - 出生年份（西元年，如：1990）
   - 月份（1-12）
   - 日期（1-31）
   - 小時（0-23）
   - 分鐘（0-59）
   - 性別（男性/女性）

#### 查詢運勢

綁定後可查詢：
- **📈 流年運勢**：整年度運勢分析
- **🌙 流月運勢**：當月運勢分析
- **☀️ 流日運勢**：當日運勢分析

**注意**：流年/流月/流日運勢需要付費會員權限

### 👤 會員資訊

點擊「👤 會員資訊」查看：
- 會員等級
- 註冊時間
- 權益說明
- 訂閱狀態（付費會員）

## 🔧 管理員功能

### 成為管理員

1. 發送管理員密語：「紫微斗數管理」
2. 輸入管理員密碼：「admin123」
3. 認證成功後獲得管理員權限

### 管理員功能

- **👥 用戶管理**：查看用戶統計
- **📊 系統統計**：查看占卜次數等統計
- **💰 付費管理**：管理付費會員（開發中）

## 🛠️ 技術架構

### 核心組件

1. **Webhook處理器** (`app/api/webhook.py`)
   - 處理LINE Bot訊息
   - 用戶會話管理
   - 功能路由分發

2. **占卜邏輯** (`app/logic/divination.py`)
   - 紫微斗數占卜計算
   - 四化解釋生成
   - 占卜記錄管理

3. **運勢分析** (`app/logic/fortune_analysis.py`)
   - 流年/流月/流日運勢計算
   - 個人命盤分析
   - 運勢格式化輸出

4. **權限管理** (`app/logic/permission_manager.py`)
   - 會員等級管理
   - 功能權限控制
   - 使用限制檢查

5. **用戶綁定** (`app/logic/user_binding.py`)
   - 命盤資訊綁定
   - 生辰資料管理
   - 綁定狀態檢查

### 數據模型

- **UserPermissions**：用戶權限和會員資訊
- **UserBirthInfo**：用戶生辰資訊
- **DivinationRecord**：占卜記錄
- **UserSession**：用戶會話狀態

## 🔒 安全考量

### 數據保護
- 生辰資訊加密存儲
- 會話狀態內存管理
- 敏感資訊環境變數配置

### 權限控制
- 分級會員制度
- 功能使用限制
- 管理員雙重認證

### API安全
- Webhook簽名驗證
- 請求頻率限制
- 錯誤處理和日誌記錄

## 🚨 常見問題

### Q: 占卜結果不準確？
A: 占卜結果基於紫微斗數理論計算，僅供參考。系統會根據當下時間和性別進行分析。

### Q: 忘記綁定的命盤資訊？
A: 目前系統不支持查看已綁定的詳細資訊，如需重新綁定請聯繫管理員。

### Q: 付費會員如何開通？
A: 付費功能正在開發中，目前可請管理員手動升級會員等級。

### Q: 系統響應慢或無響應？
A: 檢查網絡連接和服務器狀態，確保Webhook URL正確設置。

## 📈 系統監控

### 日誌檢查
```bash
tail -f app.log
```

### 數據庫狀態
```bash
sqlite3 app.db ".tables"
sqlite3 app.db "SELECT COUNT(*) FROM user_permissions;"
```

### 服務狀態
```bash
curl -X GET http://localhost:8000/
curl -X POST http://localhost:8000/webhook
```

## 🔄 更新和維護

### 代碼更新
1. 拉取最新代碼
2. 更新依賴：`pip install -r requirements.txt`
3. 運行數據庫遷移（如需要）
4. 重啟服務

### 數據備份
```bash
cp app.db app.db.backup.$(date +%Y%m%d)
```

### 日誌輪轉
建議定期清理日誌文件，避免磁盤空間不足。

## 📞 支援和聯繫

如有技術問題或建議，請聯繫開發團隊。

---

**版本**：1.0.0  
**最後更新**：2024年12月  
**作者**：紫微斗數占卜系統開發團隊 