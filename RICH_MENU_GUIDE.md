# Line Bot 圖文選單功能說明

## 🎯 功能概述

Line Bot 現在支持圖文選單功能！用戶打開對話框時會自動顯示直覺的圖文按鈕選單，無需輸入文字即可快速操作。

## 📋 圖文選單類型

### 1. 未綁定用戶選單
- **適用對象**：新用戶或尚未綁定命盤的用戶
- **功能按鈕**：
  - 🔮 本週占卜（免費體驗）
  - 🌐 前往網站（完整分析）
  - ❓ 使用說明（了解更多功能）

### 2. 已綁定用戶選單（主選單）
- **適用對象**：已完成命盤綁定的用戶
- **功能按鈕**：
  - 🔮 本週占卜（免費功能）
  - 📊 我的命盤（快速查詢）
  - 📅 流年運勢（付費功能）
  - 🌙 流月運勢（付費功能）
  - ⚙️ 設定（個人化設置）

## 🚀 設置步驟

### 1. 安裝依賴
```bash
pip install Pillow
```

### 2. 生成和設置圖文選單
```bash
# 設置圖文選單
python setup_rich_menu.py setup

# 列出現有圖文選單
python setup_rich_menu.py list

# 刪除所有圖文選單（謹慎使用）
python setup_rich_menu.py delete
```

### 3. 測試功能
```bash
python test_rich_menu.py
```

## 🔧 技術實現

### 圖文選單管理器
- **文件**: `app/utils/rich_menu_manager.py`
- **功能**: 創建、上傳、設置、刪除圖文選單

### 動態圖文選單管理器
- **文件**: `app/utils/dynamic_rich_menu.py`
- **功能**: 根據用戶綁定狀態動態設置合適的圖文選單

### 圖片生成器
- **文件**: `app/utils/rich_menu_image_generator.py`
- **功能**: 自動生成圖文選單背景圖片

## 📱 用戶體驗流程

### 新用戶流程
1. 用戶關注 Line Bot
2. 系統自動設置「未綁定用戶選單」
3. 用戶看到圖文選單：占卜、前往網站、使用說明
4. 用戶可直接點擊進行操作

### 綁定用戶流程
1. 用戶在網站完成命盤分析
2. 點擊「保存到Line帳號」
3. 返回 Line Bot 輸入「綁定」
4. 系統自動切換到「主選單」
5. 用戶看到完整功能選單

## 🎨 圖文選單設計

### 主選單 (2500x1686 像素)
```
┌─────────────┬─────────────┐
│  🔮 本週占卜  │  📊 我的命盤  │
│  免費引流功能  │   快速查詢   │
├─────┬───────┼─────────────┤
│📅流年│🌙流月 │  ⚙️ 設定   │
│付費功能│付費功能│ 個人化設置  │
└─────┴───────┴─────────────┘
```

### 未綁定用戶選單 (2500x1686 像素)
```
┌─────────────┬─────────────┐
│  🔮 本週占卜  │  🌐 前往網站  │
│   免費體驗   │   完整分析   │
├─────────────┴─────────────┤
│        ❓ 使用說明        │
│       了解更多功能        │
└─────────────────────────┘
```

## 🔄 自動切換機制

系統會在以下時機自動更新用戶的圖文選單：

1. **用戶關注時**: 檢查綁定狀態，設置對應選單
2. **完成綁定時**: 從未綁定選單切換到主選單
3. **解除綁定時**: 從主選單切換回未綁定選單

## 📁 文件結構

```
├── app/utils/
│   ├── rich_menu_manager.py          # 圖文選單管理器
│   ├── rich_menu_image_generator.py  # 圖片生成器
│   └── dynamic_rich_menu.py          # 動態選單管理器
├── rich_menu_images/                 # 生成的圖片目錄
│   ├── main_rich_menu.png            # 主選單圖片
│   └── unbound_user_rich_menu.png    # 未綁定用戶選單圖片
├── rich_menu_ids.txt                 # 選單ID記錄
├── setup_rich_menu.py                # 設置腳本
└── test_rich_menu.py                 # 測試腳本
```

## 🛠️ 配置說明

### 環境變數
確保 `config.env` 文件包含正確的 Line Bot 配置：
```env
LINE_CHANNEL_ID=your_channel_id
LINE_CHANNEL_SECRET=your_channel_secret
LINE_CHANNEL_ACCESS_TOKEN=your_access_token
```

### 網站 URL
在以下文件中更新網站 URL：
- `app/utils/rich_menu_manager.py`
- `app/api/linebot_routes.py`

目前設置為開發環境：`http://localhost:3000`

## 🧪 測試驗證

### 功能測試項目
- ✅ 圖文選單創建和管理
- ✅ 動態圖文選單載入
- ✅ 用戶狀態檢測
- ✅ 圖文選單圖片生成

### 手動測試步驟
1. 啟動 Line Bot 服務
2. 用手機掃描 Line Bot QR Code
3. 關注 Bot，檢查是否顯示圖文選單
4. 測試各個按鈕功能
5. 完成命盤綁定，驗證選單是否切換

## 🚨 注意事項

1. **圖片尺寸**: 圖文選單圖片必須是 2500x1686 像素
2. **檔案大小**: 圖片檔案大小不能超過 1MB
3. **選單數量**: Line Bot 最多可設置 1000 個圖文選單
4. **API 限制**: 圖文選單相關 API 有頻率限制
5. **權限管理**: 需要正確的 Line Bot 權限才能設置圖文選單

## 🔧 故障排除

### 常見問題

**Q: 圖文選單不顯示**
A: 檢查是否正確設置了默認圖文選單，或用戶是否有個人專屬選單

**Q: 圖片上傳失敗**
A: 確認圖片尺寸和檔案大小符合 Line 規範

**Q: 按鈕點擊無反應**
A: 檢查 PostBack 事件處理邏輯是否正確實現

**Q: 選單不會自動切換**
A: 檢查綁定狀態檢測邏輯和動態選單管理器

### 日誌檢查
```bash
# 檢查 Line Bot 日誌
tail -f logs/linebot.log

# 檢查圖文選單設置日誌
python setup_rich_menu.py list
```

## 🎉 功能完成

圖文選單功能已完全實現並測試通過！用戶現在可以通過直覺的圖形界面快速使用 Line Bot 的各項功能，大大提升了使用體驗。 