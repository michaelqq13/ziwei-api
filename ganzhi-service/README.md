# å¹²æ”¯æŸ¥è©¢å¾®æœå‹™

å°ˆé–€è™•ç†æ™‚é–“æˆ³åˆ°å¹²æ”¯è½‰æ›çš„ç¨ç«‹ FastAPI æœå‹™ï¼Œ**æ”¯æ´ç›´æ¥é€£æ¥æ‚¨çš„å®Œæ•´æ™‚é–“è³‡æ–™åº«**ã€‚

## ğŸŒŸ ä¸»è¦ç‰¹è‰²

- **è³‡æ–™åº«æ•´åˆ**ï¼šç›´æ¥é€£æ¥æ‚¨çš„ PostgreSQL æ™‚é–“è³‡æ–™åº«ï¼Œä½¿ç”¨èˆ‡ä¸»æœå‹™ç›¸åŒçš„æº–ç¢ºæ•¸æ“š
- **å¤šé‡å›é€€æ©Ÿåˆ¶**ï¼šè³‡æ–™åº« â†’ æœ¬åœ°æ•¸æ“šæ–‡ä»¶ â†’ ç®—æ³•è¨ˆç®—
- **é«˜æ€§èƒ½**ï¼šæœ¬åœ°æœå‹™èª¿ç”¨ï¼Œå»¶é² 1-5ms
- **å®¹éŒ¯è¨­è¨ˆ**ï¼šå¤šå±¤éŒ¯èª¤è™•ç†ï¼Œç¢ºä¿æœå‹™ç©©å®šæ€§
- **RESTful API**ï¼šæ¨™æº– HTTP æ¥å£ï¼Œæ˜“æ–¼é›†æˆ

## ğŸ“¦ å®‰è£å’Œé‹è¡Œ

### 1. å®‰è£ä¾è³´

```bash
cd ganzhi-service
pip install -r requirements.txt
```

### 2. é…ç½®è³‡æ–™åº«é€£æ¥

**æ–¹æ³•ä¸€ï¼šç’°å¢ƒè®Šæ•¸**
```bash
export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/ziwei"
```

**æ–¹æ³•äºŒï¼š.env æ–‡ä»¶**
```bash
# å‰µå»º .env æ–‡ä»¶
echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/ziwei" > .env
```

### 3. å•Ÿå‹•æœå‹™

```bash
python main.py
```

æœå‹™å°‡åœ¨ `http://127.0.0.1:8001` å•Ÿå‹•

## ğŸ”Œ API æ¥å£

### åŸºæœ¬è³‡è¨Š

```bash
# æœå‹™ç‹€æ…‹
GET http://127.0.0.1:8001/

# å¥åº·æª¢æŸ¥
GET http://127.0.0.1:8001/health

# è©³ç´°è³‡è¨Š
GET http://127.0.0.1:8001/info
```

### å¹²æ”¯æŸ¥è©¢

```bash
GET http://127.0.0.1:8001/ganzhi?ts=2025-07-03 14:30:00&timezone_offset=8
```

**åƒæ•¸èªªæ˜ï¼š**
- `ts`: æ™‚é–“æˆ³ï¼ˆå¿…å¡«ï¼‰
  - æ”¯æ´æ ¼å¼ï¼š`YYYY-MM-DD HH:MM:SS`ã€`YYYY-MM-DD HH:MM`ã€ISO 8601 ç­‰
- `timezone_offset`: æ™‚å€åç§»å°æ™‚ï¼ˆå¯é¸ï¼Œé»˜èª +8ï¼‰

**å›æ‡‰ç¯„ä¾‹ï¼š**
```json
{
  "success": true,
  "timestamp": "2025-07-03T14:30:00+08:00",
  "timezone": "+08:00",
  "year_ganzhi": "ä¹™å·³",
  "month_ganzhi": "å£¬åˆ",
  "day_ganzhi": "ç™¸é…‰",
  "hour_ganzhi": "è¾›é…‰",
  "minute_ganzhi": "å·±æœª",
  "solar_term": "å¤è‡³",
  "lunar_year": "ä¹™å·³",
  "lunar_month": "å…­æœˆ",
  "lunar_day": "åˆå…«",
  "data_source": "database"
}
```

## ğŸ—„ï¸ æ•¸æ“šä¾†æºå„ªå…ˆç´š

### 1. è³‡æ–™åº«æ¨¡å¼ï¼ˆæœ€æ¨è–¦ï¼‰
- ç›´æ¥é€£æ¥æ‚¨çš„ PostgreSQL æ™‚é–“è³‡æ–™åº«
- ä½¿ç”¨èˆ‡ä¸»æœå‹™ç›¸åŒçš„ `calendar_data` è³‡æ–™è¡¨
- æä¾›æœ€é«˜æº–ç¢ºæ€§çš„å¹²æ”¯è¨ˆç®—

### 2. æœ¬åœ°æ•¸æ“šæ–‡ä»¶æ¨¡å¼
å¦‚æœç„¡æ³•é€£æ¥è³‡æ–™åº«ï¼Œæœå‹™æœƒå˜—è©¦åŠ è¼‰æœ¬åœ°æ•¸æ“šæ–‡ä»¶ï¼š

```
ganzhi-service/data/
â”œâ”€â”€ complete_ganzhi_data.json      # å„ªå…ˆç´šæœ€é«˜
â”œâ”€â”€ lunar_calendar_data.json       # æ¬¡å„ªå…ˆç´š
â””â”€â”€ ç¯€æ°£è¾²æ›†å¹²æ”¯æ•¸æ“š.json           # ç¬¬ä¸‰å„ªå…ˆç´š
```

**æ•¸æ“šæ–‡ä»¶æ ¼å¼ç¯„ä¾‹ï¼š**
```json
{
  "2025-07-03 14:00:00": {
    "year_ganzhi": "ä¹™å·³",
    "month_ganzhi": "å£¬åˆ",
    "day_ganzhi": "ç™¸é…‰",
    "hour_ganzhi": "è¾›é…‰",
    "lunar_year": "ä¹™å·³",
    "lunar_month": "å…­æœˆ",
    "lunar_day": "åˆå…«"
  }
}
```

### 3. ç®—æ³•è¨ˆç®—æ¨¡å¼ï¼ˆå‚™ç”¨ï¼‰
- ç•¶ç„¡æ³•å–å¾—è³‡æ–™åº«æˆ–æœ¬åœ°æ•¸æ“šæ™‚å•Ÿç”¨
- ä½¿ç”¨ç°¡åŒ–ç®—æ³•æä¾›åŸºæœ¬å¹²æ”¯è¨ˆç®—
- é©åˆæ¸¬è©¦å’Œé–‹ç™¼ç’°å¢ƒ

## ğŸ”§ ä¸»æœå‹™é›†æˆ

åœ¨ä¸»æœå‹™ä¸­ä½¿ç”¨å¹²æ”¯æŸ¥è©¢å¾®æœå‹™ï¼š

```python
from app.services.ganzhi_service import GanzhiService

# åˆå§‹åŒ–æœå‹™
ganzhi_service = GanzhiService()

# æŸ¥è©¢å¹²æ”¯ä¿¡æ¯
result = await ganzhi_service.get_ganzhi_with_fallback(
    year=2025, month=7, day=3, hour=14, minute=30
)

print(result["day_ganzhi"])  # ç™¸é…‰
```

## ğŸ“Š æœå‹™ç›£æ§

### æª¢æŸ¥æ•¸æ“šä¾†æº
```bash
curl http://127.0.0.1:8001/info
```

**å›æ‡‰åŒ…å«ï¼š**
- `database_connected`: æ˜¯å¦æˆåŠŸé€£æ¥è³‡æ–™åº«
- `data_records`: è³‡æ–™åº«ä¸­çš„è¨˜éŒ„æ•¸é‡
- `data_source`: ç•¶å‰ä½¿ç”¨çš„æ•¸æ“šä¾†æºï¼ˆdatabase/file/algorithmï¼‰

### å¥åº·æª¢æŸ¥
```bash
curl http://127.0.0.1:8001/health
```

## âš¡ æ€§èƒ½æŒ‡æ¨™

- **æœ¬åœ°æœå‹™èª¿ç”¨**ï¼š1-5ms å»¶é²
- **è³‡æ–™åº«æŸ¥è©¢**ï¼šO(1) è¤‡é›œåº¦ï¼ˆç´¢å¼•å„ªåŒ–ï¼‰
- **å…§å­˜ä½”ç”¨**ï¼š<50MBï¼ˆç„¡æ•¸æ“šç·©å­˜æ™‚ï¼‰
- **ä¸¦ç™¼è™•ç†**ï¼šæ”¯æ´å¤šå€‹åŒæ™‚è«‹æ±‚

## ğŸš€ éƒ¨ç½²å»ºè­°

### é–‹ç™¼ç’°å¢ƒ
```bash
# èˆ‡ä¸»æœå‹™åœ¨åŒä¸€å°æ©Ÿå™¨
python main.py  # ç«¯å£ 8001
```

### ç”Ÿç”¢ç’°å¢ƒ
```bash
# ä½¿ç”¨ uvicorn éƒ¨ç½²
uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4
```

### Docker éƒ¨ç½²
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001"]
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **è³‡æ–™åº«é€£æ¥å¤±æ•—**
   ```
   ERROR: è³‡æ–™åº«é€£æ¥å¤±æ•—ï¼Œåˆ‡æ›åˆ°æ–‡ä»¶æ¨¡å¼
   ```
   - æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦é‹è¡Œ
   - ç¢ºèª `DATABASE_URL` ç’°å¢ƒè®Šæ•¸æ­£ç¢º
   - é©—è­‰è³‡æ–™åº«ç”¨æˆ¶æ¬Šé™

2. **æ‰¾ä¸åˆ°æ•¸æ“š**
   ```
   WARNING: è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°è¨˜éŒ„ï¼Œå›é€€åˆ°ç®—æ³•è¨ˆç®—
   ```
   - æª¢æŸ¥è³‡æ–™åº«ä¸­æ˜¯å¦æœ‰å°æ‡‰æ—¥æœŸçš„æ•¸æ“š
   - ç¢ºèª `calendar_data` è³‡æ–™è¡¨å­˜åœ¨ä¸”æœ‰æ•¸æ“š

3. **æœå‹™ç„¡æ³•å•Ÿå‹•**
   - ç¢ºèªç«¯å£ 8001 æœªè¢«ä½”ç”¨
   - æª¢æŸ¥ä¾è³´æ˜¯å¦æ­£ç¢ºå®‰è£

### åµéŒ¯æ¨¡å¼
```bash
# å•Ÿç”¨è©³ç´°æ—¥èªŒ
export LOG_LEVEL=debug
python main.py
```

## ğŸ¤ èˆ‡ç´«å¾®æ–—æ•¸ç³»çµ±é›†æˆ

æ­¤å¾®æœå‹™æ˜¯ç´«å¾®æ–—æ•¸ LINE Bot ç³»çµ±çš„ä¸€éƒ¨åˆ†ï¼Œå°ˆé–€è² è²¬ï¼š

1. **æ™‚é–“è¨ˆç®—è§£è€¦**ï¼šå°‡è¤‡é›œçš„æ™‚é–“è½‰æ›é‚è¼¯ç¨ç«‹å‡ºä¾†
2. **æº–ç¢ºæ€§æå‡**ï¼šä½¿ç”¨å®Œæ•´çš„æ™‚é–“è³‡æ–™åº«ç¢ºä¿è¨ˆç®—æº–ç¢º
3. **ç³»çµ±æ“´å±•**ï¼šæ”¯æ´æœªä¾†çš„åˆ†æ•£å¼éƒ¨ç½²å’Œè² è¼‰å‡è¡¡
4. **ç¶­è­·ç°¡åŒ–**ï¼šæ™‚é–“è¨ˆç®—é‚è¼¯å¯ç¨ç«‹æ¸¬è©¦å’Œæ›´æ–°

---

**æŠ€è¡“æ¶æ§‹**ï¼šFastAPI + SQLAlchemy + PostgreSQL  
**é©ç”¨å ´æ™¯**ï¼šç´«å¾®æ–—æ•¸æ’ç›¤ã€å åœç³»çµ±ã€è¾²æ›†è½‰æ›æ‡‰ç”¨ 